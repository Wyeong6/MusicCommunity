<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- namespace는 ReservationMapper.java 인터페이스의 전체 경로와 일치해야 합니다. -->
<mapper namespace="com.musicCommunity.mapper.ReservationMapper">

    <!-- Reservation 도메인 객체에 대한 resultMap 정의 -->
    <resultMap id="ReservationResultMap" type="com.musicCommunity.domain.Reservation">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="eventId" column="event_id"/>
        <result property="seatId" column="seat_id"/>
        <result property="reservationDate" column="reservation_date"/>
        <result property="status" column="status"/>
        <result property="totalPrice" column="total_price"/>
    </resultMap>

    <!-- 2. ReservationDto 객체에 대한 resultMap 정의-->
    <!-- type은 com.musicCommunity.dto.ReservationDto 경로와 일치해야 합니다. -->
    <resultMap id="ReservationDtoResultMap" type="com.musicCommunity.dto.ReservationDto">
        <!-- 쿼리에서 정의한 AS 이름(별칭)을 DTO 필드에 매핑합니다. -->
        <id property="id" column="R_ID"/>
        <result property="eventName" column="E_TITLE"/>
        <result property="seatInfo" column="S_INFO"/>
        <result property="totalPrice" column="R_TOTAL_PRICE"/>
        <result property="status" column="R_STATUS"/>
        <result property="reservationDate" column="R_DATE"/>
        <result property="eventDate" column="E_START_DATE"/>
        <result property="eventId" column="E_ID"/>
    </resultMap>

    <!--
        insertReservation: 새로운 예약 기록을 저장합니다.
        useGeneratedKeys="true"와 keyProperty="id"를 사용하여
        DB에서 생성된 PK(id)를 Reservation 객체에 자동 주입합니다.
    -->
    <insert id="insertReservation" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO reservation (
        user_id, event_id, seat_id, reservation_date, status, total_price
        ) VALUES (
        #{userId}, #{eventId}, #{seatId}, #{reservationDate}, #{status}, #{totalPrice}
        )
    </insert>
    <!--
    findByUserId: 특정 사용자의 전체 예매 기록 목록을 조회합니다.
    Event와 Seat 테이블을 조인하여 예약 상세 정보를 가져옵니다.
-->
    <select id="findByUserId" resultMap="ReservationDtoResultMap">
        SELECT
        R.id AS R_ID,
        R.reservation_date AS R_DATE,
        R.status AS R_STATUS,
        R.total_price AS R_TOTAL_PRICE,
        E.id AS E_ID,
        E.title AS E_TITLE,
        E.start_date AS E_START_DATE,
        S.id AS S_ID,
        S.seat_code AS S_INFO
        FROM
        reservation R
        INNER JOIN
        event E ON R.event_id = E.id
        INNER JOIN
        seat S ON R.seat_id = S.id
        WHERE
        R.user_id = #{userId}
        ORDER BY
        R.reservation_date DESC
    </select>
</mapper>
