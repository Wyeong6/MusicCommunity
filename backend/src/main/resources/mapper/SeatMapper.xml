<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- namespace는 SeatMapper.java 인터페이스의 전체 경로와 일치해야 합니다. -->
<mapper namespace="com.musicCommunity.mapper.SeatMapper">

    <!-- Seat 도메인 객체에 대한 resultMap 정의 -->
    <resultMap id="SeatResultMap" type="com.musicCommunity.domain.Seat">
        <id property="id" column="id"/>
        <result property="eventId" column="event_id"/>
        <result property="seatCode" column="seat_code"/>
        <result property="section" column="section"/>
        <result property="price" column="price"/>
        <result property="isReserved" column="is_reserved"/>
        <result property="reservationId" column="reservation_id"/>
    </resultMap>

    <!--
    findSeatsByEventId: 특정 이벤트 ID에 속하는 모든 좌석 정보를 조회합니다.
    (Service에서 요청하신 메서드에 대응하는 쿼리입니다.)
-->
    <select id="findSeatsByEventId" resultMap="SeatResultMap">
        SELECT
        id, event_id, seat_code, price, is_reserved, reservation_id
        FROM
        seat
        WHERE
        event_id = #{eventId}
        ORDER BY
        seat_code
    </select>

    <!--
        아임포트
        -->
    <select id="selectSeatById" resultMap="SeatResultMap">
        SELECT
        id,
        price,
        is_reserved
        FROM seat
        WHERE id = #{seatId}
    </select>

    <!--
        findAllByEventId: 특정 이벤트의 모든 좌석을 조회 (예약 상태와 무관)
    -->
    <select id="findAllByEventId" resultMap="SeatResultMap">
        SELECT
        id, event_id, seat_code, section, price, is_reserved, reservation_id
        FROM
        seat
        WHERE
        event_id = #{eventId}
        ORDER BY
        section, seat_code
    </select>

    <!--
        findAvailableSeatsByEventId: 특정 이벤트의 예약 가능한(is_reserved = FALSE) 좌석만 조회
    -->
    <select id="findAvailableSeatsByEventId" resultMap="SeatResultMap">
        SELECT
        id, event_id, seat_code, section, price, is_reserved, reservation_id
        FROM
        seat
        WHERE
        event_id = #{eventId} AND is_reserved = FALSE
        ORDER BY
        section, seat_code
    </select>

    <!--
        findByIdForUpdate: 비관적 락(FOR UPDATE)을 걸어 특정 좌석을 조회하는 쿼리
        예매 시 동시성 문제를 방지하기 위해 사용됩니다.
    -->
    <select id="findByIdForUpdate" resultMap="SeatResultMap">
        SELECT
        id, event_id, seat_code, price, is_reserved, reservation_id
        FROM
        seat
        WHERE
        id = #{seatId}
        FOR UPDATE
    </select>

    <!--
        updateSeat: 좌석의 예약 상태와 예약 ID를 업데이트
        WHERE 조건에 is_reserved = FALSE를 추가하여, 이미 예약된 좌석을 실수로 덮어쓰는 것을 방지합니다.
    -->
    <update id="updateSeat">
        UPDATE
        seat
        SET
        is_reserved = #{isReserved},
        reservation_id = #{reservationId}
        WHERE
        id = #{id}
        AND is_reserved = FALSE
    </update>

    <insert id="insertSeat" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO seat (event_id, seat_code, price, is_reserved, reservation_id)
        VALUES (#{eventId}, #{seatCode}, #{price}, #{isReserved}, #{reservationId})
    </insert>

</mapper>
